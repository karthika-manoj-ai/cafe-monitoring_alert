import cv2, time, threading, os, torch, winsound
from collections import deque
from ultralytics import YOLO
from gtts import gTTS
from playsound import playsound
from PIL import Image
from transformers import Qwen2VLForConditionalGeneration, AutoProcessor

# ================= CONFIG =================
CAMERA_ID = 0
OVER_CROWD_LIMIT = 2
CONF_THRESHOLD = 0.4
SMOOTHING_WINDOW = 5
VLM_CHECK_INTERVAL = 6
ALERT_REPEAT_INTERVAL = 5

FRAME_W, FRAME_H = 640, 480
YOLO_W, YOLO_H = 416, 416

BEEP_FREQ, BEEP_DURATION = 1000, 400
AUDIO_FILE = "alert.mp3"

# ================= MODELS =================
yolo = YOLO("yolov8n.pt")

vl_model = Qwen2VLForConditionalGeneration.from_pretrained(
    "Qwen/Qwen2-VL-2B-Instruct",
    torch_dtype=torch.float32
).to("cpu").eval()

vl_processor = AutoProcessor.from_pretrained(
    "Qwen/Qwen2-VL-2B-Instruct", use_fast=False
)

# ================= AUDIO =================
if not os.path.exists(AUDIO_FILE):
    gTTS("Alert. The cafe is overcrowded.", lang="en").save(AUDIO_FILE)

alert_active, vlm_busy, vlm_ok = False, False, False
last_vlm_time = 0
counts = deque(maxlen=SMOOTHING_WINDOW)
lock = threading.Lock()

# ================= FUNCTIONS =================
def alert_loop():
    while True:
        with lock:
            if not alert_active:
                break
        winsound.Beep(BEEP_FREQ, BEEP_DURATION)
        playsound(AUDIO_FILE)
        time.sleep(ALERT_REPEAT_INTERVAL)

def qwen_check(frame):
    img = Image.fromarray(cv2.cvtColor(frame, cv2.COLOR_BGR2RGB))
    msg = [{
        "role": "user",
        "content": [{"type": "image"},
                    {"type": "text", "text": "Is this cafe overcrowded? Answer Yes or No."}]
    }]
    prompt = vl_processor.apply_chat_template(msg, add_generation_prompt=True)
    inp = vl_processor(text=prompt, images=img, return_tensors="pt")
    with torch.no_grad():
        out = vl_model.generate(**inp, max_new_tokens=6)
    return "yes" in vl_processor.decode(out[0], skip_special_tokens=True).lower()

def run_vlm(frame):
    global vlm_busy, vlm_ok
    vlm_busy = True
    vlm_ok = qwen_check(cv2.resize(frame, (320, 240)))
    vlm_busy = False

# ================= CAMERA =================
cap = cv2.VideoCapture(CAMERA_ID, cv2.CAP_DSHOW)
cap.set(3, FRAME_W)
cap.set(4, FRAME_H)

# ================= MAIN LOOP =================
while True:
    ret, frame = cap.read()
    if not ret:
        break

    yolo_frame = cv2.resize(frame, (YOLO_W, YOLO_H))
    results = yolo(yolo_frame, conf=CONF_THRESHOLD, verbose=False)

    count = 0
    for r in results:
        for b in r.boxes:
            if int(b.cls[0]) == 0:
                count += 1
                x1, y1, x2, y2 = b.xyxy[0]
                x1, x2 = int(x1 * FRAME_W / YOLO_W), int(x2 * FRAME_W / YOLO_W)
                y1, y2 = int(y1 * FRAME_H / YOLO_H), int(y2 * FRAME_H / YOLO_H)
                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)

    counts.append(count)
    people = round(sum(counts) / len(counts))
    now = time.time()
    status = "ðŸŸ¢ Status: Normal"

    if people > OVER_CROWD_LIMIT:
        if not vlm_busy and now - last_vlm_time > VLM_CHECK_INTERVAL:
            last_vlm_time = now
            threading.Thread(target=run_vlm, args=(frame.copy(),), daemon=True).start()

        if vlm_ok:
            status = "ðŸ”´ ALERT: Overcrowded"
            with lock:
                if not alert_active:
                    alert_active = True
                    threading.Thread(target=alert_loop, daemon=True).start()
        else:
            status = "ðŸŸ¡ Crowded (checking)"
            alert_active = False
    else:
        vlm_ok = False
        alert_active = False

    # UI
    cv2.putText(frame, f"People: {people}", (20, 40),
                cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 255, 255), 2)
    cv2.putText(frame, status, (20, 80),
                cv2.FONT_HERSHEY_SIMPLEX, 0.8,
                (0, 0, 255) if "ALERT" in status else (0, 255, 0), 2)

    cv2.imshow("YOLO + Qwen2-VL Monitor", frame)
    if cv2.waitKey(1) & 0xFF == ord("q"):
        break

cap.release()
cv2.destroyAllWindows()
